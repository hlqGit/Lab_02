# Rocky 10 Kickstart

# --- Installation & System Configuration ---
# Use text-based installation mode instead of the graphical interface
text
# Set the installation source to the attached CD-ROM/ISO
cdrom
# Define the BaseOS repository location, essential for core packages
repo --name="BaseOS"    --baseurl=file:///run/install/repo/BaseOS
# Define the AppStream repository for additional applications and libraries
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream
# Set the system language to US English
lang en_US.UTF-8
# Set the keyboard layout to US standard
keyboard us
# Set the timezone to Central Time (Chicago) and configure the hardware clock to use UTC
timezone America/Chicago --utc

# Network Configuration
# Activate the primary network device on boot using DHCP to get an IP address
network --device=link --bootproto=dhcp --activate --onboot=on

# Security & Services
# Lock the root account to prevent direct login
rootpw --lock
# Enable the system firewall and allow SSH traffic
firewall --enabled --service=ssh
# Set SELinux to enforcing mode for maximum security
selinux --enforcing
# Enable critical services to start on boot: sshd (for SSH), NetworkManager (for networking), and chronyd (for time sync)
services --enabled=sshd,NetworkManager,chronyd

# Package Selection
# Specifies the beginning of the package selection section
%packages
# Install a minimal set of packages for a basic server environment
@^minimal-environment
# Marks the end of the package selection
%end

# --- Disk Partitioning ---
# Erase all partitions on the disk and create a new partition table.
clearpart --all --initlabel
# Automatically create partitions (/boot, /, swap) based on available disk space.
autopart

# --- User Creation ---
# Create a 'packer' user for the build process, add to 'wheel' for sudo access, and lock the password.
user --name=packer --groups=wheel --shell=/bin/bash --homir=/home/packer --lock
# Add the public SSH key for the 'packer' user to allow key-based login.
sshkey --username=packer "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAfqjEGdMphWtoTPrKHK9ORibkRduK9Y3qhXxkShbHho packer"

# Create an 'ansible' user for configuration management, add to 'wheel', and lock the password.
user --name=ansible --groups=wheel --shell=/bin/bash --homedir=/home/ansible --lock
# Add the public SSH key for the 'ansible' user.
sshkey --username=ansible "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILFHv1JR+Z0HLF6O2JoVwffMRNi5aJKzARk9GHTBmICW ansible"

# --- Post-Installation Script (runs inside the new system) ---
# Start the post-install script section, logging output to a file for debugging.
%post --log=/root/ks-post.log
# Set script to exit on any error ('-e'), print commands ('-x'), and handle pipe failures correctly.
set -euxo pipefail

# Loop through 'packer' and 'ansible' users to set correct SSH directory permissions.
for u in packer ansible; do
  if getent passwd "$u" >/dev/null; then
    # Get the user's home directory path.
    h="$(getent passwd "$u" | cut -d: -f6)"
    # Create the .ssh directory with secure permissions.
    install -d -m 700 -o "$u" -g "$u" "$h" "$h/.ssh"
    # Apply the correct SELinux security context to the home directory.
    restorecon -RF "$h" || true
  fi
done

# Fix DNS resolution issues by linking to NetworkManager's resolv.conf.
rm -f /etc/resolv.conf
ln -s ../run/NetworkManager/resolv.conf /etc/resolv.conf
# Apply the correct SELinux context to the new symbolic link.
restorecon -v /etc/resolv.conf || true

# Generate SSH host keys for the new system so it can accept SSH connections.
ssh-keygen -A

# Create the directory for custom sudo rules.
install -d -m 0750 /etc/sudoers.d

# Create a sudoers file to allow the 'packer' user to shut down the VM without a password.
# This is required for Packer to gracefully finish the build process.
cat >/etc/sudoers.d/90-packer-shutdown <<'EOF'
Defaults:packer !requiretty,lecture=never
packer ALL=(root) NOPASSWD: /usr/bin/systemctl poweroff, /usr/sbin/shutdown -P now
EOF

# Set the correct ownership and permissions for the new sudoers file.
chown root:root /etc/sudoers.d/90-packer-shutdown
chmod 0440 /etc/sudoers.d/90-packer-shutdown
sed -i 's/\r$//' /etc/sudoers.d/90-packer-shutdown
# Apply the correct SELinux context to the sudoers file.
restorecon -v /etc/sudoers.d/90-packer-shutdown || true

# Ensure the main sudoers file is configured to include our custom rules directory.
grep -qE '^[#]?includedir /etc/sudoers\.d' /etc/sudoers \
  || echo '#includedir /etc/sudoers.d' >> /etc/sudoers

# Validate the syntax of our new sudoers file to prevent system lockout.
if command -v visudo >/dev/null 2>&1; then
  visudo -cf /etc/sudoers.d/90-packer-shutdown \
    || echo "WARN: visudo validation failed (continuing)"
fi

# Create a temporary service to ensure SSH is running on the very first boot for Packer.
cat >/etc/systemd/system/firstboot-sshd.service <<'EOF'
[Unit]
Description=Ensure SSHD is running on first boot
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/systemctl start sshd
ExecStart=/usr/bin/systemctl disable --now firstboot-sshd.service
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd to recognize the new service and enable all required services.
systemctl daemon-reload
systemctl enable sshd NetworkManager chronyd firstboot-sshd.service

# Persistently add the SSH service to the firewall rules.
firewall-cmd --permanent --add-service=ssh || true
# Reload the firewall to apply the changes.
firewall-cmd --reload || true

# Force a full SELinux relabel of the filesystem on the next boot.
touch /.autorelabel

# End of the first post-installation script.
%end

# --- Post-Installation Script (runs in the installer environment) ---
# This script runs before the chroot pivot, it's a secondary method for setup.
%post --nochroot --log=/mnt/sysimage/root/ks-post-nochroot.log
set -euxo pipefail

# The following lines are often redundant but can fix permissions from the outside.
# Ensure the main sudoers file in the new system has the correct line endings.
sed -i 's/\r$//' /mnt/sysimage/etc/sudoers

# Ensure the sudoers include directive is present.
grep -qE '^[#]?includedir /etc/sudoers\.d' /mnt/sysimage/etc/sudoers \
  || echo '#includedir /etc/sudoers.d' >> /mnt/sysimage/etc/sudoers

# Directly append sudo rules for the packer user.
cat >> /mnt/sysimage/etc/sudoers <<'EOF'
Defaults:packer !requiretty,lecture=never
packer ALL=(root) NOPASSWD: /usr/bin/systemctl poweroff, /usr/sbin/shutdown -P now
EOF

# Run visudo check from outside the new system.
chroot /mnt/sysimage /usr/sbin/visudo -c || true

# Test if the users can actually run sudo commands.
chroot /mnt/sysimage runuser -l packer  -c "sudo -n id >/root/sudo-ok.packer"  || true
chroot /mnt/sysimage runuser -l ansible -c "sudo -n id >/root/sudo-ok.ansible" || true
# End of the second post-installation script.
%end

# --- Final Step ---
# Reboot the machine to complete the installation and boot into the new OS.
reboot